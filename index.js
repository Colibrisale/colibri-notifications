import express from "express";
import dotenv from "dotenv";
import cors from "cors";
import axios from "axios";

dotenv.config();

const app = express();
const PORT = process.env.PORT || 3000;

app.use(cors({
    origin: ["https://colibri.sale"],
    methods: "GET,POST",
    allowedHeaders: "Content-Type,Authorization"
}));

app.use(express.json());

app.get("/", (req, res) => {
    res.send("âœ… Ð¡ÐµÑ€Ð²ÐµÑ€ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚!");
});

// ðŸ”¹ Ð­Ð½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚: ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð² Shopify (Ð¢Ð•Ð“Ð˜ + ÐœÐ•Ð¢ÐÐ¤Ð˜Ð›Ð”Ð«)
app.post("/api/notifications/send", async (req, res) => {
    try {
        const { customerId, title, message } = req.body;

        if (!customerId || !title || !message) {
            console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ð½Ðµ Ñ…Ð²Ð°Ñ‚Ð°ÐµÑ‚ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð²", req.body);
            return res.status(400).json({ success: false, error: "customerId, title Ð¸ message Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹!" });
        }

        console.log("âœ… ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÑƒ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ:", req.body);

        // ðŸ·ï¸ Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚ÐµÐ³ Ð² Shopify
        const tagResponse = await axios.post(
            `https://${process.env.SHOPIFY_STORE_URL}/admin/api/2023-10/customers/${customerId}.json`,
            { customer: { id: customerId, tags: title } },
            {
                headers: {
                    "X-Shopify-Access-Token": process.env.SHOPIFY_ACCESS_TOKEN,
                    "Content-Type": "application/json",
                    "Accept": "application/json"
                }
            }
        );

        console.log("ðŸ·ï¸ Ð¢ÐµÐ³ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½:", tagResponse.data);

        // ðŸ”¹ ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ðµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¸Ð· Ð¼ÐµÑ‚Ð°Ñ„Ð¸Ð»Ð´Ð¾Ð²
        const getResponse = await axios.get(
            `https://${process.env.SHOPIFY_STORE_URL}/admin/api/2023-10/customers/${customerId}/metafields.json`,
            {
                headers: {
                    "X-Shopify-Access-Token": process.env.SHOPIFY_ACCESS_TOKEN,
                    "Accept": "application/json"
                }
            }
        );

        let existingNotifications = [];
        if (getResponse.data.metafields) {
            const notifMetafield = getResponse.data.metafields.find(m => m.namespace === "notifications");
            if (notifMetafield) {
                existingNotifications = JSON.parse(notifMetafield.value);
            }
        }

        // ðŸ†• Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð½Ð¾Ð²Ð¾Ðµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ
        const newNotification = {
            title,
            message,
            timestamp: new Date().toISOString()
        };
        existingNotifications.unshift(newNotification); // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð² Ð½Ð°Ñ‡Ð°Ð»Ð¾ ÑÐ¿Ð¸ÑÐºÐ°

        // âœï¸ Ð—Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÐ¼ Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð¾ Ð² Shopify
        await axios.post(
            `https://${process.env.SHOPIFY_STORE_URL}/admin/api/2023-10/customers/${customerId}/metafields.json`,
            {
                metafield: {
                    namespace: "notifications",
                    key: "messages",
                    value: JSON.stringify(existingNotifications),
                    type: "json_string"
                }
            },
            {
                headers: {
                    "X-Shopify-Access-Token": process.env.SHOPIFY_ACCESS_TOKEN,
                    "Content-Type": "application/json",
                    "Accept": "application/json"
                }
            }
        );

        console.log("ðŸ“© Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð¿Ð¸ÑÐ°Ð½Ð¾ Ð² Shopify:", newNotification);
        res.json({ success: true, message: "Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ Ð² Shopify!" });

    } catch (error) {
        console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐµ:", error.response ? error.response.data : error.message);
        res.status(500).json({ success: false, error: "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð² Shopify" });
    }
});

// ðŸ”¹ Ð­Ð½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚: ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
app.get("/api/notifications/get/:customerId", async (req, res) => {
    try {
        const { customerId } = req.params;

        const response = await axios.get(
            `https://${process.env.SHOPIFY_STORE_URL}/admin/api/2023-10/customers/${customerId}/metafields.json`,
            {
                headers: {
                    "X-Shopify-Access-Token": process.env.SHOPIFY_ACCESS_TOKEN,
                    "Accept": "application/json"
                }
            }
        );

        let notifications = [];
        if (response.data.metafields) {
            const notifMetafield = response.data.metafields.find(m => m.namespace === "notifications");
            if (notifMetafield) {
                notifications = JSON.parse(notifMetafield.value);
            }
        }

        res.json({ success: true, notifications });

    } catch (error) {
        console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹:", error.response ? error.response.data : error.message);
        res.status(500).json({ success: false, error: "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹" });
    }
});

// ðŸ”¹ Ð­Ð½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚: ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹ Ð¿Ð¾ÑÐ»Ðµ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð°
app.post("/api/notifications/clear", async (req, res) => {
    try {
        const { customerId } = req.body;

        await axios.post(
            `https://${process.env.SHOPIFY_STORE_URL}/admin/api/2023-10/customers/${customerId}/metafields.json`,
            {
                metafield: {
                    namespace: "notifications",
                    key: "messages",
                    value: "[]", // ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº
                    type: "json_string"
                }
            },
            {
                headers: {
                    "X-Shopify-Access-Token": process.env.SHOPIFY_ACCESS_TOKEN,
                    "Content-Type": "application/json",
                    "Accept": "application/json"
                }
            }
        );

        console.log(`ðŸ—‘ï¸ Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð´Ð»Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° ${customerId} Ð¾Ñ‡Ð¸Ñ‰ÐµÐ½Ñ‹`);
        res.json({ success: true, message: "Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¾Ñ‡Ð¸Ñ‰ÐµÐ½Ñ‹" });

    } catch (error) {
        console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹:", error.response ? error.response.data : error.message);
        res.status(500).json({ success: false, error: "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹" });
    }
});

app.listen(PORT, () => {
    console.log(`ðŸš€ Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ ${PORT}`);
});
